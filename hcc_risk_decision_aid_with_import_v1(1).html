<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HCC Risk & Decision Aid (Raman + Age)</title>
<meta name="description" content="Predict HCC risk from Raman peak ratios and age, with threshold-based recommendation, shrinkage, and prevalence recalibration." />
<style>
  .rowdiv{
    background: #e2e8f0;
    color: #0f172a;
    border-radius: 10px;
    padding: 10px 14px;
    width: 217px;
  }
  :root {
    --bg1:#f8fafc; --bg2:#ffffff;
    --card:#ffffff; --ink:#0f172a; --muted:#64748b;
    --accent:#2563eb; --ok:#059669; --warn:#dc2626;
    --line:#e5e7eb;
  }
  html,body{margin:0;padding:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
  .container{max-width:1100px;margin:0 auto;padding:0 20px;}
  .header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.85);backdrop-filter: blur(6px);
    border-bottom:1px solid rgba(226,232,240,.7);}
  .header-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 0;}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700;color:#0b1220}
  .logo{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:12px;background:var(--accent);color:#fff}
  .subtle{font-size:12px;color:#64748b}

  .main{padding:28px 0 40px;display:grid;gap:20px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 28px rgba(15,23,42,.06)}
  .card-body{padding:20px}
  h1{font-size:22px;margin:0 0 6px}
  h2{font-size:18px;margin:0}
  p{margin:0}

  .grid-2{display:grid;gap:16px}
  @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }

  .input{width:220px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:14px}
  .input:focus{outline:none;border-color:#bfdbfe;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
  .label{font-size:14px;color:#0b1220;margin-bottom:6px;display:block;height: 30px;}
  .muted{color:#64748b}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .kpi .item{background:#f8fafc;border-radius:12px;padding:12px 14px}
  .kpi .k{font-size:12px;color:#64748b}
  .kpi .v{font-size:28px;font-weight:800;color:#0b1220}
  .recommend{border-radius:14px;padding:14px;font-weight:700}
  .recommend.ok{background:#ecfdf5;color:#065f46}
  .recommend.warn{background:#fef2f2;color:#991b1b}

  .pill{background:#f1f5f9;border-radius:12px;padding:10px 12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:40px}

  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:#e2e8f0;color:#0f172a;margin-right: 61px;padding-right: 140px;}

  .footer{border-top:1px solid rgba(226,232,240,.7);background:#fff}
  .footer-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 0}

  /* small helpers */
  .mt-4{margin-top:16px} .mt-6{margin-top:24px} .mt-8{margin-top:32px} .mb-1{margin-bottom:4px}
  .text-xs{font-size:12px} .text-sm{font-size:14px} .text-center{text-align:center} .bold{font-weight:700}
  .info{display:flex;align-items:center;gap:8px;color:#64748b}
  .icon{width:18px;height:18px;display:inline-block}
</style>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <div class="brand">
        <span class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" class="icon" fill="currentColor"><path d="M12 2l2.2 5.8L20 10l-5.8 2.2L12 18l-2.2-5.8L4 10l5.8-2.2L12 2z"/></svg>
        </span>
        HCC Risk & Decision Aid
      </div>
      <div class="subtle">Raman Peaks + Age · Logistic Model</div>
    </div>
  </header>

  <main class="container main">
    <section class="card">
      <div class="card-body">
        <h1>Predict risk from Raman peak ratios and age</h1>
        <p class="subtle mt-1">Enter age and raw peak intensities (500, 650, 720, 1035 cm⁻¹). The tool computes ratios (<strong>650/500, 720/500, 1035/500</strong>) and outputs a predicted probability with a threshold-based recommendation. Advanced settings support uniform shrinkage and prevalence recalibration.</p>
      </div>
    </section>

    <section class="grid-2">
      <!-- Patient Inputs -->
      <div class="card">
        <div class="card-body">
          <h2>Patient Inputs</h2>
          <div class="mt-4 row">
            <div>
              <label class="label" for="age">Age (years)</label>
              <input class="input" id="age" type="number" min="0" value="60" />
            </div>
            <div></div>

            <div>
              <label class="label" for="i500">Peak intensity 500 cm⁻¹</label>
              <input class="input" id="i500" type="number" step="0.0001" min="0" value="1.00" />
            </div>
            <div>
              <label class="label" for="i650">Peak intensity 650 cm⁻¹ <span class="subtle">(optional; needed if model uses <strong>650/500</strong>)</span></label>
              <input class="input" id="i650" type="number" step="0.0001" min="0" placeholder="optional" />
            </div>

            <div>
              <label class="label" for="i720">Peak intensity 720 cm⁻¹</label>
              <input class="input" id="i720" type="number" step="0.0001" min="0" value="1.00" />
            </div>
            <div>
              <label class="label" for="i1035">Peak intensity 1035 cm⁻¹</label>
              <input class="input" id="i1035" type="number" step="0.0001" min="0" value="1.00" />
            </div>
          </div>

          
          <div class="pill mt-4" id="spectrumImport">
            <div class="info">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M4 12a8 8 0 1116 0A8 8 0 014 12z"></path>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
              </svg>
              Import Raman spectrum <span class="subtle">(CSV: shift,intensity)</span>
            </div>

            <div class="mt-4" style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
              <button class="btn ghost" type="button" id="btnImport">Import (.CSV)</button>
              <input id="specFile" type="file" accept=".csv,text/csv" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0" />

              <div style="min-width:220px">
                <label class="label" for="peakWin">Peak window ±cm⁻¹</label>
                <input class="input" id="peakWin" type="number" step="0.1" min="0" value="10" />
              </div>

              <div style="flex:1;min-width:240px">
                <div class="text-xs muted" id="specStatus">No file loaded.</div>
              </div>
            </div>
          </div>

<div class="pill mt-4">
            <div class="info"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M11 7h2v2h-2zM11 11h2v6h-2z"/><path d="M12 2a10 10 0 100 20 10 10 0 000-20zM4 12a8 8 0 1116 0A8 8 0 014 12z"/></svg>Auto-computed ratios</div>
            <div class="row mt-4">
              <div class="rowdiv">650/500 → <span class="bold" id="r650_500">NA</span></div>
              <div class="rowdiv">720/500 → <span class="bold" id="r720_500">1.0000</span></div>
              <div class="rowdiv">1035/500 → <span class="bold" id="r1035_500">1.0000</span></div>
            </div>
            <div class="text-xs muted mt-4">If 650 is left empty while the model uses <strong>650/500</strong>, that term is treated as 0 (may underestimate risk).</div>
          </div>
        </div>
      </div>

      <!-- Scenario & Threshold -->
      <div class="card">
        <div class="card-body">
          <h2>Use-case & Threshold</h2>
          <div class="mt-4 row">
            <div>
              <label class="label" for="scenario">Scenario</label>
              <select class="input" id="scenario">
                <option value="cirrhosis">HBV-cirrhosis surveillance clinic</option>
                <option value="checkup">General check-up</option>
              </select>
            </div>
            <div>
              <label class="label" for="thr">Decision threshold p<sub>t</sub></label>
              <input class="input" id="thr" type="number" step="0.0001" min="0" max="1" value="0.05" />
            </div>
          </div>

          <div class="kpi mt-6">
            <div class="item">
              <div class="k">Predicted probability</div>
              <div class="v" id="p_out">0.00%</div>
            </div>
            <div class="item">
              <div class="k">Threshold p<sub>t</sub></div>
              <div class="v" id="thr_out">5.00%</div>
            </div>
            <div class="item">
              <div class="k">Recommendation</div>
              <div class="recommend ok" id="decision">No intervention; routine follow-up</div>
            </div>
          </div>

          <p class="text-xs muted mt-4">Threshold reflects tolerance for false positives vs. missed cases. Higher p<sub>t</sub> penalizes false positives more.</p>
        </div>
      </div>
    </section>

    <!-- Coefficients -->
    <section class="card">
      <div class="card-body">
        <h2>Model Coefficients</h2>
        <p class="text-sm muted mt-1">Prefilled from your final logistic model. You can edit below. The model now uses <strong>x/500</strong> features directly (no reciprocals).</p>
        <div class="mt-4" style="display:grid;grid-template-columns:repeat(5,1fr);gap:14px">
          <div>
            <label class="label" for="b0">Intercept (β₀)</label>
            <input class="input" id="b0" type="number" step="0.000001" value="-6.7180528703" />
          </div>
          <div>
            <label class="label" for="bAge">Age (β₁)</label>
            <input class="input" id="bAge" type="number" step="0.000001" value="0.1085953017" />
          </div>
          <div>
            <label class="label" for="b12720">720/500 (β₂)</label>
            <input class="input" id="b12720" type="number" step="0.000001" value="0.8924109223" />
          </div>
          <div>
            <label class="label" for="b11035">1035/500 (β₃)</label>
            <input class="input" id="b11035" type="number" step="0.000001" value="0.7350571922" />
          </div>
          <div>
            <label class="label" for="b10650">650/500 (β₄)</label>
            <input class="input" id="b10650" type="number" step="0.000001" value="0.4331492809" />
          </div>
        </div>

        <div class="mt-6" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
          <div>
            <label class="label" for="s">Uniform shrinkage s</label>
            <input class="input" id="s" type="number" step="0.01" value="1.00" />
            <div class="text-xs muted mt-1">Set <strong>s</strong> to calibration slope (e.g., 0.77) if you apply uniform shrinkage.</div>
          </div>
          <div>
            <label class="label" for="piDev">Development prevalence π<sub>dev</sub></label>
            <input class="input" id="piDev" type="number" step="0.0001" min="0" max="1" value="0.61" />
          </div>
          <div>
            <label class="label" for="piTar">Target prevalence π<sub>target</sub></label>
            <input class="input" id="piTar" type="number" step="0.0001" min="0" max="1" value="0.03" />
          </div>
        </div>

        <div class="mt-6" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn primary" id="save">Save settings</button>
          <button class="btn ghost" id="reset">Reset</button>
          <span class="subtle">Settings persist in your browser (localStorage).</span>
        </div>

        <p class="text-xs muted mt-6">Formula: p = logistic( β₀ + s·[β₁·Age + β₂·(720/500) + β₃·(1035/500) + β₄·(650/500)] + Δ ), where Δ = logit(π<sub>target</sub>) − logit(π<sub>dev</sub>).</p>
      </div>
    </section>

    <section class="text-xs subtle">
      <p>Research use only. Clinical decisions require appropriate validation and context.</p>
    </section>
  </main>

  <footer class="footer">
    <div class="container footer-inner text-xs subtle">
      <span>© HCC Raman Nomogram — Research Use Only</span>
      <span>Clean · Minimal · Accessible</span>
    </div>
  </footer>

<script>
  // Utilities
  const clamp = (x, lo, hi) => Math.min(hi, Math.max(lo, x));
  const logistic = (z) => 1/(1+Math.exp(-z));
  const logit = (p) => Math.log(p/(1-p));
  const fmtPct = (p)=> (100*Math.min(1, Math.max(0, p))).toFixed(2) + '%';

  // Elements
  const age = document.getElementById('age');
  const i500 = document.getElementById('i500');
  const i650 = document.getElementById('i650');
  const i720 = document.getElementById('i720');
  const i1035 = document.getElementById('i1035');
  const r650_500 = document.getElementById('r650_500');
  const r720_500 = document.getElementById('r720_500');
  const r1035_500 = document.getElementById('r1035_500');

  // Spectrum import UI (CSV: shift,intensity)
  const btnImport = document.getElementById('btnImport');
  const specFile = document.getElementById('specFile');
  const peakWin = document.getElementById('peakWin');
  const specStatus = document.getElementById('specStatus');

  let lastSpectrum = null; // { name, shift:[], intensity:[], smooth:[] }

  function _reflectIndex(k, n) {
    if (k < 0) return -k;
    if (k >= n) return (2*n - 2) - k;
    return k;
  }

  // Savitzky–Golay smoothing (window=11, polyorder=3). Fixed coefficients.
  function _savgol11_3(y) {
    const c = [-36, 9, 44, 69, 84, 89, 84, 69, 44, 9, -36];
    const d = 429;
    const n = y.length;
    const out = new Array(n);
    for (let i = 0; i < n; i++) {
      let sum = 0;
      for (let j = -5; j <= 5; j++) {
        sum += c[j + 5] * y[_reflectIndex(i + j, n)];
      }
      out[i] = sum / d;
    }
    return out;
  }

  function _parseSpectrumText(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l && !l.startsWith('#'));
    const xs = [], ys = [];

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      // Skip header if present
      if (i === 0 && /shift|wavenumber|raman/i.test(line) && /inten/i.test(line)) continue;

      const parts = (line.includes(',') ? line.split(',') : line.split(/\s+/)).map(s => s.trim());
      if (parts.length < 2) continue;

      const x = Number(parts[0]);
      const y = Number(parts[1]);
      if (!isFinite(x) || !isFinite(y)) continue;

      xs.push(x); ys.push(y);
    }

    if (xs.length < 20) throw new Error('Spectrum must contain at least ~20 numeric rows (two columns).');

    // Sort by shift ascending
    const idx = xs.map((v, i) => [v, i]).sort((a, b) => a[0] - b[0]).map(p => p[1]);
    return {
      shift: idx.map(i => xs[i]),
      intensity: idx.map(i => ys[i])
    };
  }

  function _peakMaxInWindow(shift, ySmooth, target, win) {
    const w = Math.max(0, Number(win) || 0);
    let bestI = -Infinity;
    let bestX = NaN;
    let found = false;

    for (let i = 0; i < shift.length; i++) {
      if (Math.abs(shift[i] - target) <= w) {
        found = true;
        if (ySmooth[i] > bestI) { bestI = ySmooth[i]; bestX = shift[i]; }
      }
    }
    if (!found || !isFinite(bestI)) return { target, found: false };
    return { target, found: true, center: bestX, amplitude: bestI };
  }

  function _updatePeaksFromSpectrum() {
    if (!lastSpectrum) return;

    const win = Number(peakWin && peakWin.value) || 10;
    const shift = lastSpectrum.shift;
    const smooth = lastSpectrum.smooth;

    const p500  = _peakMaxInWindow(shift, smooth, 500,  win);
    const p650  = _peakMaxInWindow(shift, smooth, 650,  win);
    const p720  = _peakMaxInWindow(shift, smooth, 720,  win);
    const p1035 = _peakMaxInWindow(shift, smooth, 1035, win);

    // Fill peak intensity inputs (only if found)
    if (p500.found)  i500.value  = String(p500.amplitude);
    if (p650.found)  i650.value  = String(p650.amplitude);
    if (p720.found)  i720.value  = String(p720.amplitude);
    if (p1035.found) i1035.value = String(p1035.amplitude);

    const mn = shift[0], mx = shift[shift.length - 1];
    if (specStatus) {
      specStatus.textContent =
        `${lastSpectrum.name} loaded (${shift.length} points, ${mn.toFixed(1)}–${mx.toFixed(1)} cm⁻¹). `
        + `Peaks: 500→${p500.found ? p500.center.toFixed(1) : 'NA'}, `
        + `650→${p650.found ? p650.center.toFixed(1) : 'NA'}, `
        + `720→${p720.found ? p720.center.toFixed(1) : 'NA'}, `
        + `1035→${p1035.found ? p1035.center.toFixed(1) : 'NA'}.`;
    }

    // Update downstream
    compute();
  }

  async function _handleSpectrumFile(file) {
    const text = await file.text();
    const parsed = _parseSpectrumText(text);
    const smooth = _savgol11_3(parsed.intensity);
    lastSpectrum = { name: file.name || 'spectrum.csv', shift: parsed.shift, intensity: parsed.intensity, smooth };

    _updatePeaksFromSpectrum();
  }

  if (btnImport && specFile) {
    btnImport.addEventListener('click', () => specFile.click());
    specFile.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try {
        if (specStatus) specStatus.textContent = 'Loading…';
        await _handleSpectrumFile(f);
      } catch (err) {
        if (specStatus) specStatus.textContent = `Import failed: ${err && err.message ? err.message : err}`;
      }
    });
  }

  if (peakWin) {
    peakWin.addEventListener('input', () => {
      if (lastSpectrum) _updatePeaksFromSpectrum();
    });
  }


  const scenario = document.getElementById('scenario');
  const thr = document.getElementById('thr');
  const p_out = document.getElementById('p_out');
  const thr_out = document.getElementById('thr_out');
  const decision = document.getElementById('decision');

  const b0 = document.getElementById('b0');
  const bAge = document.getElementById('bAge');
  // Treat these as β for x/500
  const b12720 = document.getElementById('b12720'); // 720/500
  const b11035 = document.getElementById('b11035'); // 1035/500
  const b10650 = document.getElementById('b10650'); // 650/500

  const s = document.getElementById('s');
  const piDev = document.getElementById('piDev');
  const piTar = document.getElementById('piTar');

  // Compute UI ratios as x/500
  function ratios() {
    const I500 = Number(i500.value);
    const I650 = Number(i650.value);
    const I720 = Number(i720.value);
    const I1035 = Number(i1035.value);

    const r650 = (I500>0 && I650>=0) ? (I650/I500) : NaN;    // 650/500
    const r720 = (I500>0 && I720>=0) ? (I720/I500) : NaN;    // 720/500
    const r1035= (I500>0 && I1035>=0)? (I1035/I500): NaN;    // 1035/500

    r650_500.textContent  = isFinite(r650)  ? r650.toFixed(4)  : 'NA';
    r720_500.textContent  = isFinite(r720)  ? r720.toFixed(4)  : 'NA';
    r1035_500.textContent = isFinite(r1035) ? r1035.toFixed(4) : 'NA';
    return { r650, r720, r1035 };
  }

  function updateScenarioDefaults() {
    if (scenario.value === 'cirrhosis') {
      if (!thr.dataset.touched) thr.value = 0.05;
      if (!piTar.dataset.touched) piTar.value = 0.03;
    } else {
      if (!thr.dataset.touched) thr.value = 0.005;
      if (!piTar.dataset.touched) piTar.value = 0.0002;
    }
  }

  function compute() {
    const { r650, r720, r1035 } = ratios();

    const B0 = Number(b0.value)||0;
    const BA = Number(bAge.value)||0;
    const B_720_500  = Number(b12720.value)||0;
    const B_1035_500 = Number(b11035.value)||0;
    const B_650_500  = Number(b10650.value)||0;
    const S    = Number(s.value)||1;

    const Age = Number(age.value)||0;

    // DIRECT use of x/500 ratios (no reciprocals)
    const LP_nonInt = (BA*Age)
      + (isFinite(r720)  ? B_720_500  * r720  : 0)
      + (isFinite(r1035) ? B_1035_500 * r1035 : 0)
      + (isFinite(r650)  ? B_650_500  * r650  : 0);

    // prevalence recalibration-in-the-large (delta on intercept)
    const dev = clamp(Number(piDev.value)||0, 1e-6, 1-1e-6);
    const tar = clamp(Number(piTar.value)||0, 1e-12, 1-1e-12);
    const delta = logit(tar) - logit(dev);

    const LP = B0 + S*LP_nonInt + delta;
    const p = logistic(LP);

    const t = Math.min(1, Math.max(0, Number(thr.value)||0));

    p_out.textContent = fmtPct(p);
    thr_out.textContent = fmtPct(t);

    const need = (p >= t);
    decision.className = 'recommend ' + (need ? 'warn' : 'ok');
    decision.textContent = need ? 'Recommend further work-up' : 'No intervention; routine follow-up';
  }

  function save() {
    const data = {
      age: age.value, i500: i500.value, i650: i650.value, i720: i720.value, i1035: i1035.value,
      scenario: scenario.value, thr: thr.value,
      peakWin: (peakWin ? peakWin.value : 10),
      b0: b0.value, bAge: bAge.value, b12720: b12720.value, b11035: b11035.value, b10650: b10650.value,
      s: s.value, piDev: piDev.value, piTar: piTar.value
    };
    localStorage.setItem('hcc_calc_refined_en', JSON.stringify(data));
    alert('Saved to your browser');
  }

  function load() {
    const raw = localStorage.getItem('hcc_calc_refined_en');
    if (!raw) return;
    try {
      const d = JSON.parse(raw);
      for (const [k,v] of Object.entries(d)) {
        const el = document.getElementById(k);
        if (el) el.value = v;
      }
    } catch(e) {}
  }

  function resetAll() {
    localStorage.removeItem('hcc_calc_refined_en');
    age.value=60; i500.value=1; i650.value=''; i720.value=1; i1035.value=1;
    if (peakWin) peakWin.value = 10;
    if (specFile) specFile.value = '';
    if (specStatus) specStatus.textContent = 'No file loaded.';
    lastSpectrum = null;

    scenario.value='cirrhosis'; thr.value=0.05;
    b0.value=-6.7180528703; bAge.value=0.1085953017; b12720.value=0.8924109223; b11035.value=0.7350571922; b10650.value=0.4331492809;
    s.value=1.00; piDev.value=0.61; piTar.value=0.03;
    thr.dataset.touched=''; piTar.dataset.touched='';
    compute();
  }

  // Events
  ;['input','change'].forEach(ev => {
    [age,i500,i650,i720,i1035,thr,b0,bAge,b12720,b11035,b10650,s,piDev,piTar].forEach(el => el.addEventListener(ev, () => {
      if (el===thr) thr.dataset.touched='1';
      if (el===piTar) piTar.dataset.touched='1';
      compute();
    }));
  });
  scenario.addEventListener('change', () => { updateScenarioDefaults(); compute(); });

  document.getElementById('save').addEventListener('click', save);
  document.getElementById('reset').addEventListener('click', resetAll);

  // Init
  load();
  updateScenarioDefaults();
  compute();
</script>
</body>
</html>
